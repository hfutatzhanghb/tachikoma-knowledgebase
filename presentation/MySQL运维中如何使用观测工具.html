<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MySQL运维中如何使用观测工具</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="35oc" id="mysql运维中如何使用观测工具">MySQL运维中如何使用观测工具</h1><hr><div class="md-section-divider"></div><h2 data-anchor-id="c6d5" id="目录">目录</h2><ul data-anchor-id="9jwb">
<li>BPF 应用n例</li>
<li>观测工具的介绍</li>
<li>BPF 脚本/限制</li>
<li>PMC 应用一例</li>
</ul><hr><div class="md-section-divider"></div><h2 data-anchor-id="16y2" id="bpf-应用n例">BPF 应用n例</h2><hr><div class="md-section-divider"></div><h3 data-anchor-id="6urq" id="bpf-命名">BPF 命名</h3><ul data-anchor-id="o24f">
<li>BPF = <strong>Berkeley Packet Filter</strong></li>
<li><a href="https://en.wikipedia.org/wiki/Berkeley_Packet_Filter" target="_blank">https://en.wikipedia.org/wiki/Berkeley_Packet_Filter</a></li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="rb9n"><ol class="linenums"><li class="L0"><code><span class="typ">The</span><span class="pln"> </span><span class="typ">Berkeley</span><span class="pln"> </span><span class="typ">Packet</span><span class="pln"> </span><span class="typ">Filter</span><span class="pln"> </span><span class="pun">(</span><span class="pln">BPF</span><span class="pun">)</span><span class="pln"> provides a raw </span><span class="kwd">interface</span><span class="pln"> to data link layers</span><span class="pun">,</span><span class="pln"> permitting raw link</span><span class="pun">-</span><span class="pln">layer packets to be sent </span><span class="kwd">and</span><span class="pln"> received</span><span class="pun">.</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pun">...</span></code></li><li class="L2"><code><span class="pln">BPF supports filtering packets</span><span class="pun">,</span><span class="pln"> allowing a userspace process to supply a filter program that specifies which packets it wants to receive</span><span class="pun">.</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pun">...</span></code></li><li class="L4"><code><span class="pln">BPF </span><span class="kwd">is</span><span class="pln"> sometimes used to refer just to the filtering mechanism</span><span class="pun">,</span><span class="pln"> rather than to the entire </span><span class="kwd">interface</span><span class="pun">.</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pun">...</span></code></li><li class="L6"><code><span class="typ">Since</span><span class="pln"> version </span><span class="lit">3.18</span><span class="pun">,</span><span class="pln"> the </span><span class="typ">Linux</span><span class="pln"> kernel includes an extended BPF </span><span class="kwd">virtual</span><span class="pln"> machine</span><span class="pun">,</span><span class="pln"> termed extended BPF </span><span class="pun">(</span><span class="pln">eBPF</span><span class="pun">).</span><span class="pln"> </span><span class="typ">It</span><span class="pln"> can be used </span><span class="kwd">for</span><span class="pln"> non</span><span class="pun">-</span><span class="pln">networking purposes</span><span class="pun">...</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h3 data-anchor-id="j448" id="bcc">BCC</h3><p data-anchor-id="l8bo">可以认为是BPF的脚本集</p><p data-anchor-id="6r4n"><a href="https://github.com/iovisor/bcc" target="_blank">https://github.com/iovisor/bcc</a></p><hr><div class="md-section-divider"></div><h3 data-anchor-id="9ljw" id="mysql请求延迟分布">MySQL请求延迟分布</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="lnt7"><ol class="linenums"><li class="L0"><code><span class="com">//Only select</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./dbstat -p `pidof mysqld` -u -- mysql</span></code></li><li class="L3"><code><span class="typ">Tracing</span><span class="pln"> database queries </span><span class="kwd">for</span><span class="pln"> pids </span><span class="lit">4754</span><span class="pln"> slower than </span><span class="lit">0</span><span class="pln"> ms</span><span class="pun">...</span></code></li><li class="L4"><code><span class="pun">^</span><span class="pln">C</span><span class="pun">[</span><span class="lit">11</span><span class="pun">:</span><span class="lit">20</span><span class="pun">:</span><span class="lit">53</span><span class="pun">]</span></code></li><li class="L5"><code><span class="pln">     query latency </span><span class="pun">(</span><span class="pln">us</span><span class="pun">)</span><span class="pln">  </span><span class="pun">:</span><span class="pln"> count     distribution</span></code></li><li class="L6"><code><span class="pln">         </span><span class="lit">0</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pln">         </span><span class="lit">2</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">3</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L8"><code><span class="pln">         </span><span class="lit">4</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">7</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pln">         </span><span class="lit">8</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">15</span><span class="pln">         </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L0"><code><span class="pln">        </span><span class="lit">16</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">31</span><span class="pln">         </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L1"><code><span class="pln">        </span><span class="lit">32</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">63</span><span class="pln">         </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L2"><code><span class="pln">        </span><span class="lit">64</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">127</span><span class="pln">        </span><span class="pun">:</span><span class="pln"> </span><span class="lit">400308</span><span class="pln">   </span><span class="pun">|****************************************|</span></code></li><li class="L3"><code><span class="pln">       </span><span class="lit">128</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">255</span><span class="pln">        </span><span class="pun">:</span><span class="pln"> </span><span class="lit">148021</span><span class="pln">   </span><span class="pun">|**************</span><span class="pln">                          </span><span class="pun">|</span></code></li><li class="L4"><code><span class="pln">       </span><span class="lit">256</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">511</span><span class="pln">        </span><span class="pun">:</span><span class="pln"> </span><span class="lit">261</span><span class="pln">      </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L5"><code><span class="pln">       </span><span class="lit">512</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1023</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">3</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L6"><code><span class="pln">      </span><span class="lit">1024</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">2047</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pln">      </span><span class="lit">2048</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">4095</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L8"><code><span class="pln">      </span><span class="lit">4096</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">8191</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">3</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pln">      </span><span class="lit">8192</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">16383</span><span class="pln">      </span><span class="pun">:</span><span class="pln"> </span><span class="lit">9</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="duv9"><ol class="linenums"><li class="L0"><code><span class="com">// Select and update</span></code></li><li class="L1"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./dbstat -p `pidof mysqld` -u -- mysql</span></code></li><li class="L2"><code><span class="typ">Tracing</span><span class="pln"> database queries </span><span class="kwd">for</span><span class="pln"> pids </span><span class="lit">4754</span><span class="pln"> slower than </span><span class="lit">0</span><span class="pln"> ms</span><span class="pun">...</span></code></li><li class="L3"><code><span class="pun">^</span><span class="pln">C</span><span class="pun">[</span><span class="lit">11</span><span class="pun">:</span><span class="lit">20</span><span class="pun">:</span><span class="lit">33</span><span class="pun">]</span></code></li><li class="L4"><code><span class="pln">     query latency </span><span class="pun">(</span><span class="pln">us</span><span class="pun">)</span><span class="pln">  </span><span class="pun">:</span><span class="pln"> count     distribution</span></code></li><li class="L5"><code><span class="pln">         </span><span class="lit">0</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L6"><code><span class="pln">         </span><span class="lit">2</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">3</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pln">         </span><span class="lit">4</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">7</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L8"><code><span class="pln">         </span><span class="lit">8</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">15</span><span class="pln">         </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pln">        </span><span class="lit">16</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">31</span><span class="pln">         </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L0"><code><span class="pln">        </span><span class="lit">32</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">63</span><span class="pln">         </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L1"><code><span class="pln">        </span><span class="lit">64</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">127</span><span class="pln">        </span><span class="pun">:</span><span class="pln"> </span><span class="lit">9198</span><span class="pln">     </span><span class="pun">|**************</span><span class="pln">                          </span><span class="pun">|</span></code></li><li class="L2"><code><span class="pln">       </span><span class="lit">128</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">255</span><span class="pln">        </span><span class="pun">:</span><span class="pln"> </span><span class="lit">25826</span><span class="pln">    </span><span class="pun">|****************************************|</span></code></li><li class="L3"><code><span class="pln">       </span><span class="lit">256</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">511</span><span class="pln">        </span><span class="pun">:</span><span class="pln"> </span><span class="lit">17629</span><span class="pln">    </span><span class="pun">|***************************</span><span class="pln">             </span><span class="pun">|</span></code></li><li class="L4"><code><span class="pln">       </span><span class="lit">512</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1023</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">14568</span><span class="pln">    </span><span class="pun">|**********************</span><span class="pln">                  </span><span class="pun">|</span></code></li><li class="L5"><code><span class="pln">      </span><span class="lit">1024</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">2047</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">12533</span><span class="pln">    </span><span class="pun">|*******************</span><span class="pln">                     </span><span class="pun">|</span></code></li><li class="L6"><code><span class="pln">      </span><span class="lit">2048</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">4095</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">9840</span><span class="pln">     </span><span class="pun">|***************</span><span class="pln">                         </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pln">      </span><span class="lit">4096</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">8191</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">4031</span><span class="pln">     </span><span class="pun">|******</span><span class="pln">                                  </span><span class="pun">|</span></code></li><li class="L8"><code><span class="pln">      </span><span class="lit">8192</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">16383</span><span class="pln">      </span><span class="pun">:</span><span class="pln"> </span><span class="lit">463</span><span class="pln">      </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pln">     </span><span class="lit">16384</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">32767</span><span class="pln">      </span><span class="pun">:</span><span class="pln"> </span><span class="lit">33</span><span class="pln">       </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L0"><code><span class="pln">     </span><span class="lit">32768</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">65535</span><span class="pln">      </span><span class="pun">:</span><span class="pln"> </span><span class="lit">20</span><span class="pln">       </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L1"><code><span class="pln">     </span><span class="lit">65536</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">131071</span><span class="pln">     </span><span class="pun">:</span><span class="pln"> </span><span class="lit">20</span><span class="pln">       </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h3 data-anchor-id="yt2c" id="慢日志分析">慢日志分析</h3><p data-anchor-id="v2ir">比起MySQL的慢日志, 优点在于可以定制脚本, 使得只获取前几个结果, 降低开启慢日志的负载</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="2wxv"><ol class="linenums"><li class="L0"><code><span class="com">// Select and update</span></code></li><li class="L1"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./dbslower -p `pidof mysqld` -m 5 -- mysql</span></code></li><li class="L2"><code><span class="typ">Tracing</span><span class="pln"> database queries </span><span class="kwd">for</span><span class="pln"> pids </span><span class="lit">4754</span><span class="pln"> slower than </span><span class="lit">5</span><span class="pln"> ms</span><span class="pun">...</span></code></li><li class="L3"><code><span class="pln">TIME</span><span class="pun">(</span><span class="pln">s</span><span class="pun">)</span><span class="pln">        PID          MS QUERY</span></code></li><li class="L4"><code><span class="lit">0.956044</span><span class="pln">       </span><span class="lit">4754</span><span class="pln">      </span><span class="lit">5.358</span><span class="pln"> UPDATE sbtest1 SET k</span><span class="pun">=</span><span class="pln">k</span><span class="pun">+</span><span class="lit">1</span><span class="pln"> WHERE id</span><span class="pun">=</span><span class="lit">514</span></code></li><li class="L5"><code><span class="lit">0.956199</span><span class="pln">       </span><span class="lit">4754</span><span class="pln">      </span><span class="lit">5.837</span><span class="pln"> UPDATE sbtest1 SET k</span><span class="pun">=</span><span class="pln">k</span><span class="pun">+</span><span class="lit">1</span><span class="pln"> WHERE id</span><span class="pun">=</span><span class="lit">505</span></code></li><li class="L6"><code><span class="lit">0.956876</span><span class="pln">       </span><span class="lit">4754</span><span class="pln">      </span><span class="lit">5.257</span><span class="pln"> UPDATE sbtest1 SET k</span><span class="pun">=</span><span class="pln">k</span><span class="pun">+</span><span class="lit">1</span><span class="pln"> WHERE id</span><span class="pun">=</span><span class="lit">503</span></code></li><li class="L7"><code><span class="lit">0.955977</span><span class="pln">       </span><span class="lit">4754</span><span class="pln">      </span><span class="lit">6.656</span><span class="pln"> UPDATE sbtest1 SET k</span><span class="pun">=</span><span class="pln">k</span><span class="pun">+</span><span class="lit">1</span><span class="pln"> WHERE id</span><span class="pun">=</span><span class="lit">503</span></code></li><li class="L8"><code><span class="lit">0.956287</span><span class="pln">       </span><span class="lit">4754</span><span class="pln">      </span><span class="lit">6.801</span><span class="pln"> UPDATE sbtest1 SET k</span><span class="pun">=</span><span class="pln">k</span><span class="pun">+</span><span class="lit">1</span><span class="pln"> WHERE id</span><span class="pun">=</span><span class="lit">503</span></code></li><li class="L9"><code><span class="lit">0.955870</span><span class="pln">       </span><span class="lit">4754</span><span class="pln">      </span><span class="lit">7.554</span><span class="pln"> UPDATE sbtest1 SET k</span><span class="pun">=</span><span class="pln">k</span><span class="pun">+</span><span class="lit">1</span><span class="pln"> WHERE id</span><span class="pun">=</span><span class="lit">498</span></code></li><li class="L0"><code><span class="lit">0.956329</span><span class="pln">       </span><span class="lit">4754</span><span class="pln">      </span><span class="lit">7.121</span><span class="pln"> UPDATE sbtest1 SET k</span><span class="pun">=</span><span class="pln">k</span><span class="pun">+</span><span class="lit">1</span><span class="pln"> WHERE id</span><span class="pun">=</span><span class="lit">497</span></code></li><li class="L1"><code><span class="pun">...</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h3 data-anchor-id="kiz0" id="存储延迟分析">存储延迟分析</h3><p data-anchor-id="d4ts"><strong>存储延迟是否正常, 依赖于正常业务压力下的基线和当前压力下状态是否一致.</strong></p><hr><div class="md-section-divider"></div><h4 data-anchor-id="9tzi" id="存储架构">存储架构</h4><p data-anchor-id="wbq9"><a href="https://www.thomas-krenn.com/en/wiki/Linux_Storage_Stack_Diagram" target="_blank">https://www.thomas-krenn.com/en/wiki/Linux_Storage_Stack_Diagram</a></p><p data-anchor-id="0s70"><img src="https://www.thomas-krenn.com/de/wikiDE/images/e/e6/Linux-io-stack-diagram_v0.1.png" alt="Linux I/O Stack Diagram" title=""></p><hr><div class="md-section-divider"></div><h4 data-anchor-id="kk00" id="vfs-延迟分析">VFS 延迟分析</h4><p data-anchor-id="xpq3">可以观察read/write/fsync等VFS调用的延迟情况, 若出现与基线不符, 或者较明显的双峰图, 要考虑有其他原因的影响</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="8s94"><ol class="linenums"><li class="L0"><code><span class="com">// Select and update</span></code></li><li class="L1"><code><span class="pln">root@R730</span><span class="pun">-</span><span class="lit">117</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./ext4dist 2 1</span></code></li><li class="L2"><code><span class="typ">Tracing</span><span class="pln"> ext4 operation latency</span><span class="pun">...</span><span class="pln"> </span><span class="typ">Hit</span><span class="pln"> </span><span class="typ">Ctrl</span><span class="pun">-</span><span class="pln">C to </span><span class="kwd">end</span><span class="pun">.</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">39</span><span class="pun">:</span><span class="lit">52</span><span class="pun">:</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">operation </span><span class="pun">=</span><span class="pln"> read</span></code></li><li class="L7"><code><span class="pln">               usecs                         </span><span class="pun">:</span><span class="pln"> count     distribution</span></code></li><li class="L8"><code><span class="pln">                   </span><span class="lit">0</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pln">                   </span><span class="lit">2</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">3</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">3</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L0"><code><span class="pln">                   </span><span class="lit">4</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">7</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">19596</span><span class="pln">    </span><span class="pun">|***********</span><span class="pln">         </span><span class="pun">|</span></code></li><li class="L1"><code><span class="pln">                   </span><span class="lit">8</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">15</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">32887</span><span class="pln">    </span><span class="pun">|********************|</span></code></li><li class="L2"><code><span class="pln">                  </span><span class="lit">16</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">31</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">2649</span><span class="pln">     </span><span class="pun">|*</span><span class="pln">                   </span><span class="pun">|</span></code></li><li class="L3"><code><span class="pln">                  </span><span class="lit">32</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">63</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">303</span><span class="pln">      </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L4"><code><span class="pln">                  </span><span class="lit">64</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">127</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">48</span><span class="pln">       </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L5"><code><span class="pln">                 </span><span class="lit">128</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">255</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">15</span><span class="pln">       </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L6"><code><span class="pln">                 </span><span class="lit">256</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">511</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">3</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pun">…</span></code></li><li class="L8"><code><span class="pln">operation </span><span class="pun">=</span><span class="pln"> write</span></code></li><li class="L9"><code><span class="pln">               usecs                         </span><span class="pun">:</span><span class="pln"> count     distribution</span></code></li><li class="L0"><code><span class="pln">                   </span><span class="lit">0</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L1"><code><span class="pln">                   </span><span class="lit">2</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">3</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">2</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L2"><code><span class="pln">                   </span><span class="lit">4</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">7</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">507</span><span class="pln">      </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L3"><code><span class="pln">                   </span><span class="lit">8</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">15</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">22123</span><span class="pln">    </span><span class="pun">|********************|</span></code></li><li class="L4"><code><span class="pln">                  </span><span class="lit">16</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">31</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">10444</span><span class="pln">    </span><span class="pun">|*********</span><span class="pln">           </span><span class="pun">|</span></code></li><li class="L5"><code><span class="pln">                  </span><span class="lit">32</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">63</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">2073</span><span class="pln">     </span><span class="pun">|*</span><span class="pln">                   </span><span class="pun">|</span></code></li><li class="L6"><code><span class="pln">                  </span><span class="lit">64</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">127</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">590</span><span class="pln">      </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pln">                 </span><span class="lit">128</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">255</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">174</span><span class="pln">      </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L8"><code><span class="pln">                 </span><span class="lit">256</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">511</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">240</span><span class="pln">      </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pun">…</span></code></li><li class="L0"><code><span class="pln">operation </span><span class="pun">=</span><span class="pln"> fsync</span></code></li><li class="L1"><code><span class="pln">               usecs                         </span><span class="pun">:</span><span class="pln"> count     distribution</span></code></li><li class="L2"><code><span class="pln">                   </span><span class="lit">0</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">166</span><span class="pln">      </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L3"><code><span class="pln">                   </span><span class="lit">2</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">3</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">291</span><span class="pln">      </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L4"><code><span class="pln">                   </span><span class="lit">4</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">7</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">446</span><span class="pln">      </span><span class="pun">|*</span><span class="pln">                   </span><span class="pun">|</span></code></li><li class="L5"><code><span class="pln">                   </span><span class="lit">8</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">15</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">22</span><span class="pln">       </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L6"><code><span class="pln">                  </span><span class="lit">16</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">31</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">3</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pln">                  </span><span class="lit">32</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">63</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L8"><code><span class="pln">                  </span><span class="lit">64</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">127</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">2847</span><span class="pln">     </span><span class="pun">|*******</span><span class="pln">             </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pln">                 </span><span class="lit">128</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">255</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">7164</span><span class="pln">     </span><span class="pun">|********************|</span></code></li><li class="L0"><code><span class="pln">                 </span><span class="lit">256</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">511</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">4292</span><span class="pln">     </span><span class="pun">|***********</span><span class="pln">         </span><span class="pun">|</span></code></li><li class="L1"><code><span class="pln">                 </span><span class="lit">512</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1023</span><span class="pln">                 </span><span class="pun">:</span><span class="pln"> </span><span class="lit">882</span><span class="pln">      </span><span class="pun">|**</span><span class="pln">                  </span><span class="pun">|</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="8itt" id="ext4-延迟分析">Ext4 延迟分析</h4><p data-anchor-id="yid3">可以看到插入数据时, 对文件系统的压力集中在innodb log和data文件. 且对log的文件的写延迟较低 (顺序写)</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="20tb"><ol class="linenums"><li class="L0"><code><span class="com">//Insert data</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./ext4slower 1</span></code></li><li class="L3"><code><span class="typ">Tracing</span><span class="pln"> ext4 operations slower than </span><span class="lit">1</span><span class="pln"> ms</span></code></li><li class="L4"><code><span class="pln">TIME     COMM           PID    T BYTES   OFF_KB   LAT</span><span class="pun">(</span><span class="pln">ms</span><span class="pun">)</span><span class="pln"> FILENAME</span></code></li><li class="L5"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">40</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">3.56</span><span class="pln"> ib_logfile1</span></code></li><li class="L6"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">40</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">8.42</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li><li class="L7"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">41</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">3.83</span><span class="pln"> ib_logfile1</span></code></li><li class="L8"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">41</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">8.35</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li><li class="L9"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">42</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">8.50</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li><li class="L0"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">42</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">3.53</span><span class="pln"> ib_logfile1</span></code></li><li class="L1"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">42</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">8.34</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li><li class="L2"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">43</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">2.69</span><span class="pln"> ib_logfile1</span></code></li><li class="L3"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">43</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">8.41</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li><li class="L4"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">44</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">8.37</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li><li class="L5"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">44</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">4.13</span><span class="pln"> ib_logfile1</span></code></li><li class="L6"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">44</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">8.38</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li><li class="L7"><code><span class="lit">21</span><span class="pun">:</span><span class="lit">59</span><span class="pun">:</span><span class="lit">45</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">           </span><span class="lit">8.52</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li></ol></pre><p data-anchor-id="h31i">可用于分析其他程序对数据库的磁盘IO影响, 比如使用dd产生test1.img:</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="zjp2"><ol class="linenums"><li class="L0"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./ext4slower 10</span></code></li><li class="L1"><code><span class="typ">Tracing</span><span class="pln"> ext4 operations slower than </span><span class="lit">10</span><span class="pln"> ms</span></code></li><li class="L2"><code><span class="pln">TIME     COMM           PID    T BYTES   OFF_KB   LAT</span><span class="pun">(</span><span class="pln">ms</span><span class="pun">)</span><span class="pln"> FILENAME</span></code></li><li class="L3"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">03</span><span class="pun">:</span><span class="lit">14</span><span class="pln"> dd             </span><span class="lit">42639</span><span class="pln">  W </span><span class="lit">1073741824</span><span class="pln"> </span><span class="lit">0</span><span class="pln">         </span><span class="lit">873.20</span><span class="pln"> test1</span><span class="pun">.</span><span class="pln">img</span></code></li><li class="L4"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">03</span><span class="pun">:</span><span class="lit">15</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   W </span><span class="lit">1048576</span><span class="pln"> </span><span class="lit">1024</span><span class="pln">       </span><span class="lit">16.48</span><span class="pln"> ibdata1</span></code></li><li class="L5"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">03</span><span class="pun">:</span><span class="lit">15</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   W </span><span class="lit">507904</span><span class="pln">  </span><span class="lit">2048</span><span class="pln">       </span><span class="lit">13.98</span><span class="pln"> ibdata1</span></code></li><li class="L6"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">03</span><span class="pun">:</span><span class="lit">15</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   W </span><span class="lit">1048576</span><span class="pln"> </span><span class="lit">1302528</span><span class="pln">    </span><span class="lit">15.10</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li><li class="L7"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">03</span><span class="pun">:</span><span class="lit">15</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   S </span><span class="lit">0</span><span class="pln">       </span><span class="lit">0</span><span class="pln">         </span><span class="lit">110.94</span><span class="pln"> ibdata1</span></code></li><li class="L8"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">03</span><span class="pun">:</span><span class="lit">16</span><span class="pln"> mysqld         </span><span class="lit">4754</span><span class="pln">   W </span><span class="lit">1048576</span><span class="pln"> </span><span class="lit">1306624</span><span class="pln">    </span><span class="lit">22.35</span><span class="pln"> sbtest1</span><span class="pun">.</span><span class="pln">ibd</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="33hd" id="块设备延迟分析">块设备延迟分析</h4><p data-anchor-id="xar6">读写数据库压力</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="tu0r"><ol class="linenums"><li class="L0"><code><span class="com">//Select and update</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">root@R730</span><span class="pun">-</span><span class="lit">117</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./biolatency -D 2</span></code></li><li class="L3"><code><span class="typ">Tracing</span><span class="pln"> block device I</span><span class="pun">/</span><span class="pln">O</span><span class="pun">...</span><span class="pln"> </span><span class="typ">Hit</span><span class="pln"> </span><span class="typ">Ctrl</span><span class="pun">-</span><span class="pln">C to </span><span class="kwd">end</span><span class="pun">.</span></code></li><li class="L4"><code></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">disk </span><span class="pun">=</span><span class="pln"> </span><span class="str">'sdb'</span></code></li><li class="L7"><code><span class="pln">               usecs                         </span><span class="pun">:</span><span class="pln"> count     distribution</span></code></li><li class="L8"><code><span class="pln">                   </span><span class="lit">0</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pln">                   </span><span class="lit">2</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">3</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L0"><code><span class="pln">                   </span><span class="lit">4</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">7</span><span class="pln">                    </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L1"><code><span class="pln">                   </span><span class="lit">8</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">15</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L2"><code><span class="pln">                  </span><span class="lit">16</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">31</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L3"><code><span class="pln">                  </span><span class="lit">32</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">63</span><span class="pln">                   </span><span class="pun">:</span><span class="pln"> </span><span class="lit">4694</span><span class="pln">     </span><span class="pun">|********************|</span></code></li><li class="L4"><code><span class="pln">                  </span><span class="lit">64</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">127</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">3399</span><span class="pln">     </span><span class="pun">|**************</span><span class="pln">      </span><span class="pun">|</span></code></li><li class="L5"><code><span class="pln">                 </span><span class="lit">128</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">255</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">2211</span><span class="pln">     </span><span class="pun">|*********</span><span class="pln">           </span><span class="pun">|</span></code></li><li class="L6"><code><span class="pln">                 </span><span class="lit">256</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">511</span><span class="pln">                  </span><span class="pun">:</span><span class="pln"> </span><span class="lit">2250</span><span class="pln">     </span><span class="pun">|*********</span><span class="pln">           </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pln">                 </span><span class="lit">512</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1023</span><span class="pln">                 </span><span class="pun">:</span><span class="pln"> </span><span class="lit">642</span><span class="pln">      </span><span class="pun">|**</span><span class="pln">                  </span><span class="pun">|</span></code></li><li class="L8"><code><span class="pln">                </span><span class="lit">1024</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">2047</span><span class="pln">                 </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pln">                </span><span class="lit">2048</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">4095</span><span class="pln">                 </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                    </span><span class="pun">|</span></code></li></ol></pre><p data-anchor-id="g9c1">读数据库压力, 大部分压力由innodb buffer承受, 增加磁盘IO无益于性能调优</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="pmhn"><ol class="linenums"><li class="L0"><code><span class="pln">root@R730</span><span class="pun">-</span><span class="lit">117</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./biolatency -D 2</span></code></li><li class="L1"><code><span class="typ">Tracing</span><span class="pln"> block device I</span><span class="pun">/</span><span class="pln">O</span><span class="pun">...</span><span class="pln"> </span><span class="typ">Hit</span><span class="pln"> </span><span class="typ">Ctrl</span><span class="pun">-</span><span class="pln">C to </span><span class="kwd">end</span><span class="pun">.</span></code></li><li class="L2"><code></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">disk </span><span class="pun">=</span><span class="pln"> </span><span class="str">'sdb'</span></code></li><li class="L5"><code><span class="pln">     usecs               </span><span class="pun">:</span><span class="pln"> count     distribution</span></code></li><li class="L6"><code><span class="pln">         </span><span class="lit">0</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pln">         </span><span class="lit">2</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">3</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L8"><code><span class="pln">         </span><span class="lit">4</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">7</span><span class="pln">          </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L9"><code><span class="pln">         </span><span class="lit">8</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">15</span><span class="pln">         </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L0"><code><span class="pln">        </span><span class="lit">16</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">31</span><span class="pln">         </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L1"><code><span class="pln">        </span><span class="lit">32</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">63</span><span class="pln">         </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L2"><code><span class="pln">        </span><span class="lit">64</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">127</span><span class="pln">        </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L3"><code><span class="pln">       </span><span class="lit">128</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">255</span><span class="pln">        </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L4"><code><span class="pln">       </span><span class="lit">256</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">511</span><span class="pln">        </span><span class="pun">:</span><span class="pln"> </span><span class="lit">2</span><span class="pln">        </span><span class="pun">|**************************</span><span class="pln">              </span><span class="pun">|</span></code></li><li class="L5"><code><span class="pln">       </span><span class="lit">512</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">1023</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L6"><code><span class="pln">      </span><span class="lit">1024</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">2047</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">        </span><span class="pun">|</span><span class="pln">                                        </span><span class="pun">|</span></code></li><li class="L7"><code><span class="pln">      </span><span class="lit">2048</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">4095</span><span class="pln">       </span><span class="pun">:</span><span class="pln"> </span><span class="lit">3</span><span class="pln">        </span><span class="pun">|****************************************|</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="j0y1" id="mysql线程对文件的io压力汇总">MySQL线程对文件的IO压力汇总</h4><p data-anchor-id="wu6g">通过下例可以看到:  <br>
1. 开启了general log, 一部分写压力集中在general log上 <br>
2. 写压力还分布在ib_logfile1, ibdata的压力非常轻 <br>
3. 根据TID可找到压力较大的线程的对应SQL, 排查问题</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="hvg7"><ol class="linenums"><li class="L0"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./filetop -p `pidof mysqld` -C 5</span></code></li><li class="L1"><code><span class="typ">Tracing</span><span class="pun">...</span><span class="pln"> </span><span class="typ">Output</span><span class="pln"> every </span><span class="lit">5</span><span class="pln"> secs</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Hit</span><span class="pln"> </span><span class="typ">Ctrl</span><span class="pun">-</span><span class="pln">C to </span><span class="kwd">end</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">26</span><span class="pun">:</span><span class="lit">30</span><span class="pln"> loadavg</span><span class="pun">:</span><span class="pln"> </span><span class="lit">7.50</span><span class="pln"> </span><span class="lit">5.28</span><span class="pln"> </span><span class="lit">4.87</span><span class="pln"> </span><span class="lit">18</span><span class="pun">/</span><span class="lit">1925</span><span class="pln"> </span><span class="lit">44235</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">TID    COMM             READS  WRITES R_Kb    W_Kb    T FILE</span></code></li><li class="L6"><code><span class="lit">39956</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">115</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">462</span><span class="pln">     R ib_logfile1</span></code></li><li class="L7"><code><span class="lit">40075</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">107</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">424</span><span class="pln">     R ib_logfile1</span></code></li><li class="L8"><code><span class="lit">39900</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">1220</span><span class="pln">   </span><span class="lit">0</span><span class="pln">       </span><span class="lit">137</span><span class="pln">     R R820</span><span class="pun">-</span><span class="lit">08.log</span></code></li><li class="L9"><code><span class="lit">38046</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">1263</span><span class="pln">   </span><span class="lit">0</span><span class="pln">       </span><span class="lit">142</span><span class="pln">     R R820</span><span class="pun">-</span><span class="lit">08.log</span></code></li><li class="L0"><code><span class="lit">39085</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">101</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">332</span><span class="pln">     R ib_logfile1</span></code></li><li class="L1"><code><span class="lit">38957</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">114</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">425</span><span class="pln">     R ib_logfile1</span></code></li><li class="L2"><code><span class="lit">39959</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">1</span><span class="pln">      </span><span class="lit">0</span><span class="pln">       </span><span class="lit">2</span><span class="pln">       R ibmPAQIO</span></code></li><li class="L3"><code><span class="lit">4780</span><span class="pln">   mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">4</span><span class="pln">      </span><span class="lit">0</span><span class="pln">       </span><span class="lit">28</span><span class="pln">      R ib_logfile1</span></code></li><li class="L4"><code><span class="lit">40266</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">107</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">361</span><span class="pln">     R ib_logfile1</span></code></li><li class="L5"><code><span class="lit">39984</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">111</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">414</span><span class="pln">     R ib_logfile1</span></code></li><li class="L6"><code><span class="lit">39991</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">1211</span><span class="pln">   </span><span class="lit">0</span><span class="pln">       </span><span class="lit">136</span><span class="pln">     R R820</span><span class="pun">-</span><span class="lit">08.log</span></code></li><li class="L7"><code><span class="lit">37224</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">104</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">449</span><span class="pln">     R ib_logfile1</span></code></li><li class="L8"><code><span class="lit">40259</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">109</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">340</span><span class="pln">     R ib_logfile1</span></code></li><li class="L9"><code><span class="lit">39958</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">107</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">342</span><span class="pln">     R ib_logfile1</span></code></li><li class="L0"><code><span class="lit">39969</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">1214</span><span class="pln">   </span><span class="lit">0</span><span class="pln">       </span><span class="lit">137</span><span class="pln">     R R820</span><span class="pun">-</span><span class="lit">08.log</span></code></li><li class="L1"><code><span class="lit">39966</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">1275</span><span class="pln">   </span><span class="lit">0</span><span class="pln">       </span><span class="lit">144</span><span class="pln">     R R820</span><span class="pun">-</span><span class="lit">08.log</span></code></li><li class="L2"><code><span class="lit">39937</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">1227</span><span class="pln">   </span><span class="lit">0</span><span class="pln">       </span><span class="lit">138</span><span class="pln">     R R820</span><span class="pun">-</span><span class="lit">08.log</span></code></li><li class="L3"><code><span class="lit">39930</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">109</span><span class="pln">    </span><span class="lit">0</span><span class="pln">       </span><span class="lit">402</span><span class="pln">     R ib_logfile1</span></code></li><li class="L4"><code><span class="lit">39982</span><span class="pln">  mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">1268</span><span class="pln">   </span><span class="lit">0</span><span class="pln">       </span><span class="lit">143</span><span class="pln">     R R820</span><span class="pun">-</span><span class="lit">08.log</span></code></li><li class="L5"><code><span class="lit">4775</span><span class="pln">   mysqld           </span><span class="lit">0</span><span class="pln">      </span><span class="lit">11</span><span class="pln">     </span><span class="lit">0</span><span class="pln">       </span><span class="lit">8432</span><span class="pln">    R ibdata1</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="k5g2" id="短生命周期的临时文件检测">短生命周期的临时文件检测</h4><p data-anchor-id="fxsa">短生命周期的临时表, 由于生存周期短, 通过文件句柄可能不易检测. 有可能会影响性能.</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="wtmy"><ol class="linenums"><li class="L0"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./filelife</span></code></li><li class="L1"><code><span class="pln">TIME     PID    COMM             AGE</span><span class="pun">(</span><span class="pln">s</span><span class="pun">)</span><span class="pln">  FILE</span></code></li><li class="L2"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">17</span><span class="pun">:</span><span class="lit">01</span><span class="pln"> </span><span class="lit">43687</span><span class="pln">  cron             </span><span class="lit">0.00</span><span class="pln">    tmpfgHF5vY</span></code></li><li class="L3"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">22</span><span class="pun">:</span><span class="lit">21</span><span class="pln"> </span><span class="lit">39170</span><span class="pln">  mysqld           </span><span class="lit">5.30</span><span class="pln">    </span><span class="com">#sql1292_59a1f_0.frm</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h3 data-anchor-id="0n1g" id="网络相关">网络相关</h3><div class="md-section-divider"></div><h4 data-anchor-id="ok7d" id="短连接分析">短连接分析</h4><p data-anchor-id="i9l2">生存了300ms的短连接, 不易察觉, 但会引起短时间流量上升.</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ivwl"><ol class="linenums"><li class="L0"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./tcplife</span></code></li><li class="L1"><code><span class="pln">PID   COMM       LADDR           LPORT RADDR           RPORT TX_KB RX_KB MS</span></code></li><li class="L2"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35038</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">16</span><span class="pln">   </span><span class="lit">699</span><span class="pln"> </span><span class="lit">312.05</span></code></li><li class="L3"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35036</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">17</span><span class="pln">   </span><span class="lit">736</span><span class="pln"> </span><span class="lit">312.20</span></code></li><li class="L4"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35034</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">15</span><span class="pln">   </span><span class="lit">662</span><span class="pln"> </span><span class="lit">312.41</span></code></li><li class="L5"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35032</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">14</span><span class="pln">   </span><span class="lit">638</span><span class="pln"> </span><span class="lit">312.45</span></code></li><li class="L6"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35026</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">14</span><span class="pln">   </span><span class="lit">626</span><span class="pln"> </span><span class="lit">313.17</span></code></li><li class="L7"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35028</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">12</span><span class="pln">   </span><span class="lit">552</span><span class="pln"> </span><span class="lit">313.18</span></code></li><li class="L8"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35022</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">17</span><span class="pln">   </span><span class="lit">736</span><span class="pln"> </span><span class="lit">313.66</span></code></li><li class="L9"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35018</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">13</span><span class="pln">   </span><span class="lit">589</span><span class="pln"> </span><span class="lit">313.86</span></code></li><li class="L0"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35016</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">13</span><span class="pln">   </span><span class="lit">589</span><span class="pln"> </span><span class="lit">314.00</span></code></li><li class="L1"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35014</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">14</span><span class="pln">   </span><span class="lit">626</span><span class="pln"> </span><span class="lit">314.11</span></code></li><li class="L2"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35012</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">17</span><span class="pln">   </span><span class="lit">761</span><span class="pln"> </span><span class="lit">314.15</span></code></li><li class="L3"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35010</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">17</span><span class="pln">   </span><span class="lit">736</span><span class="pln"> </span><span class="lit">314.60</span></code></li><li class="L4"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35008</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">15</span><span class="pln">   </span><span class="lit">663</span><span class="pln"> </span><span class="lit">314.66</span></code></li><li class="L5"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35004</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">16</span><span class="pln">   </span><span class="lit">699</span><span class="pln"> </span><span class="lit">314.74</span></code></li><li class="L6"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35002</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">15</span><span class="pln">   </span><span class="lit">663</span><span class="pln"> </span><span class="lit">315.05</span></code></li><li class="L7"><code><span class="lit">44245</span><span class="pln"> sysbench   </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">35000</span><span class="pln"> </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">       </span><span class="lit">3306</span><span class="pln">     </span><span class="lit">15</span><span class="pln">   </span><span class="lit">699</span><span class="pln"> </span><span class="lit">315.09</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h4 data-anchor-id="4exe" id="连接流量">连接流量</h4><p data-anchor-id="4t0x">分析哪个客户端的流量比较大, 读取或写入了较大的数据集. </p><p data-anchor-id="ob34">可防止某个连接流量够大, 占用过多资源.</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="8dee"><ol class="linenums"><li class="L0"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/usr/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">bcc</span><span class="pun">/</span><span class="pln">tools</span><span class="com"># ./tcptop -C 5</span></code></li><li class="L1"><code><span class="typ">Tracing</span><span class="pun">...</span><span class="pln"> </span><span class="typ">Output</span><span class="pln"> every </span><span class="lit">5</span><span class="pln"> secs</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Hit</span><span class="pln"> </span><span class="typ">Ctrl</span><span class="pun">-</span><span class="pln">C to </span><span class="kwd">end</span></code></li><li class="L2"><code><span class="lit">22</span><span class="pun">:</span><span class="lit">33</span><span class="pun">:</span><span class="lit">41</span><span class="pln"> loadavg</span><span class="pun">:</span><span class="pln"> </span><span class="lit">17.28</span><span class="pln"> </span><span class="lit">6.81</span><span class="pln"> </span><span class="lit">5.01</span><span class="pln"> </span><span class="lit">126</span><span class="pun">/</span><span class="lit">1933</span><span class="pln"> </span><span class="lit">44788</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">PID    COMM         LADDR                 RADDR                  RX_KB  TX_KB</span></code></li><li class="L5"><code><span class="lit">44668</span><span class="pln">  sysbench     </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35654</span><span class="pln">       </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">         </span><span class="lit">16116</span><span class="pln">    </span><span class="lit">369</span></code></li><li class="L6"><code><span class="lit">44669</span><span class="pln">  sysbench     </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35650</span><span class="pln">       </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">         </span><span class="lit">15957</span><span class="pln">    </span><span class="lit">365</span></code></li><li class="L7"><code><span class="lit">44702</span><span class="pln">  sysbench     </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35728</span><span class="pln">       </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">         </span><span class="lit">15871</span><span class="pln">    </span><span class="lit">363</span></code></li><li class="L8"><code><span class="lit">44758</span><span class="pln">  sysbench     </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35838</span><span class="pln">       </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">         </span><span class="lit">15834</span><span class="pln">    </span><span class="lit">362</span></code></li><li class="L9"><code><span class="lit">44698</span><span class="pln">  sysbench     </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35718</span><span class="pln">       </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">         </span><span class="lit">15797</span><span class="pln">    </span><span class="lit">362</span></code></li><li class="L0"><code><span class="pun">…</span></code></li><li class="L1"><code></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">PID    COMM         LADDR6                           RADDR6                            RX_KB  TX_KB</span></code></li><li class="L4"><code><span class="lit">39188</span><span class="pln">  mysqld       </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">            </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35654</span><span class="pln">              </span><span class="lit">410</span><span class="pln">  </span><span class="lit">17810</span></code></li><li class="L5"><code><span class="lit">39184</span><span class="pln">  mysqld       </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">            </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35682</span><span class="pln">              </span><span class="lit">405</span><span class="pln">  </span><span class="lit">17589</span></code></li><li class="L6"><code><span class="lit">40037</span><span class="pln">  mysqld       </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">            </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35890</span><span class="pln">              </span><span class="lit">404</span><span class="pln">  </span><span class="lit">17552</span></code></li><li class="L7"><code><span class="lit">39182</span><span class="pln">  mysqld       </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">            </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35670</span><span class="pln">              </span><span class="lit">404</span><span class="pln">  </span><span class="lit">17491</span></code></li><li class="L8"><code><span class="lit">39180</span><span class="pln">  mysqld       </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">3306</span><span class="pln">            </span><span class="pun">::</span><span class="pln">ffff</span><span class="pun">:</span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">35688</span><span class="pln">              </span><span class="lit">404</span><span class="pln">  </span><span class="lit">17540</span></code></li><li class="L9"><code><span class="pun">...</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="b7ve" id="cpu消耗分析">CPU消耗分析</h3><div class="md-section-divider"></div><h4 data-anchor-id="2ctj" id="on-cpu-off-cpu">on-cpu &amp; off-cpu</h4><p data-anchor-id="3xzo"><a href="http://www.brendangregg.com/offcpuanalysis.html" target="_blank">http://www.brendangregg.com/offcpuanalysis.html</a></p><p data-anchor-id="bkjx"><img src="http://www.brendangregg.com/Perf/thread_states.png" alt="此处输入图片的描述" title=""></p><hr><div class="md-section-divider"></div><h4 data-anchor-id="jpxs" id="off-cpu">off-cpu</h4><p data-anchor-id="z3n9"><a href="http://www.brendangregg.com/offcpuanalysis.html" target="_blank">http://www.brendangregg.com/offcpuanalysis.html</a></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ugok"><ol class="linenums"><li class="L0"><code><span class="com"># /usr/share/bcc/tools/offcputime -df -p `pgrep -nx mysqld` 30 &gt; out.stacks</span></code></li><li class="L1"><code><span class="pun">[...</span><span class="pln">copy </span><span class="kwd">out</span><span class="pun">.</span><span class="pln">stacks to your </span><span class="kwd">local</span><span class="pln"> system </span><span class="kwd">if</span><span class="pln"> desired</span><span class="pun">...]</span></code></li><li class="L2"><code><span class="com"># git clone https://github.com/brendangregg/FlameGraph</span></code></li><li class="L3"><code><span class="com"># cd FlameGraph</span></code></li><li class="L4"><code><span class="com"># ./flamegraph.pl --color=io --title="Off-CPU Time Flame Graph" --countname=us &lt; out.stacks &gt; out.svg</span></code></li></ol></pre><p data-anchor-id="wydl"><img src="http://www.brendangregg.com/FlameGraphs/off-mysqld2.svg" alt="Off-CPU MySQL" title=""></p><div class="md-section-divider"></div><h2 data-anchor-id="wosr" id="观测工具的介绍">观测工具的介绍</h2><p data-anchor-id="on78"><a href="https://jvns.ca/blog/2017/07/05/linux-tracing-systems/" target="_blank">https://jvns.ca/blog/2017/07/05/linux-tracing-systems/</a></p><hr><div class="md-section-divider"></div><h3 data-anchor-id="jerw" id="观测流程">观测流程</h3><ol data-anchor-id="u8up">
<li>数据源</li>
<li>数据采集过程</li>
<li>数据处理前端</li>
</ol><p data-anchor-id="4ws7"><img src="https://drawings.jvns.ca/drawings/linux-tracing-1.png" alt="Linux tracing systems" title=""></p><hr><div class="md-section-divider"></div><h3 data-anchor-id="xknn" id="ebpf与perf">eBPF与perf</h3><p data-anchor-id="eqm3"><img src="https://drawings.jvns.ca/drawings/linux-tracing-3.png" alt="此处输入图片的描述" title=""></p><hr><div class="md-section-divider"></div><h3 data-anchor-id="t0oa" id="ebpf与systemtap">eBPF与systemtap</h3><p data-anchor-id="5pvz"><img src="https://drawings.jvns.ca/drawings/linux-tracing-4.png" alt="此处输入图片的描述" title=""></p><div class="md-section-divider"></div><hr><div class="md-section-divider"></div><h2 data-anchor-id="1h5e" id="bpf脚本与限制">BPF脚本与限制</h2><div class="md-section-divider"></div><h3 data-anchor-id="ymg5" id="bpf脚本">BPF脚本</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="dn9l"><ol class="linenums"><li class="L0"><code><span class="com">//一段C++代码, 嵌入kprobe/uprobe</span></code></li><li class="L1"><code><span class="pln">program </span><span class="pun">=</span><span class="pln"> </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">#include &lt;uapi/linux/ptrace.h&gt;</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="str">BPF_HASH(temp, u64, u64); //临时容器</span></code></li><li class="L5"><code><span class="str">BPF_HISTOGRAM(latency); //存放结果的容器</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="str">int probe_start(struct pt_regs *ctx) {</span></code></li><li class="L8"><code><span class="str">    u64 timestamp = bpf_ktime_get_ns(); //快速获取时间戳</span></code></li><li class="L9"><code><span class="str">    u64 pid = bpf_get_current_pid_tgid();</span></code></li><li class="L0"><code><span class="str">    temp.update(&amp;pid, &amp;timestamp);</span></code></li><li class="L1"><code><span class="str">    return 0;</span></code></li><li class="L2"><code><span class="str">}</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="str">int probe_end(struct pt_regs *ctx) {</span></code></li><li class="L5"><code><span class="str">    u64 *timestampp;</span></code></li><li class="L6"><code><span class="str">    u64 pid = bpf_get_current_pid_tgid();</span></code></li><li class="L7"><code><span class="str">    timestampp = temp.lookup(&amp;pid);</span></code></li><li class="L8"><code><span class="str">    if (!timestampp)</span></code></li><li class="L9"><code><span class="str">        return 0;</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="str">    u64 delta = bpf_ktime_get_ns() - *timestampp; //获取时间差</span></code></li><li class="L2"><code><span class="str">    FILTER</span></code></li><li class="L3"><code><span class="str">    delta /= SCALE; //规范化时间差</span></code></li><li class="L4"><code><span class="str">    latency.increment(bpf_log2l(delta)); //存放结果</span></code></li><li class="L5"><code><span class="str">    temp.delete(&amp;pid);</span></code></li><li class="L6"><code><span class="str">    return 0;</span></code></li><li class="L7"><code><span class="str">}</span></code></li><li class="L8"><code><span class="str">"""</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pun">...</span></code></li><li class="L1"><code><span class="com">// 将代码嵌入uprobe</span></code></li><li class="L2"><code><span class="pln">usdts </span><span class="pun">=</span><span class="pln"> map</span><span class="pun">(</span><span class="kwd">lambda</span><span class="pln"> pid</span><span class="pun">:</span><span class="pln"> USDT</span><span class="pun">(</span><span class="pln">pid</span><span class="pun">=</span><span class="pln">pid</span><span class="pun">),</span><span class="pln"> args</span><span class="pun">.</span><span class="pln">pids</span><span class="pun">)</span></code></li><li class="L3"><code><span class="kwd">for</span><span class="pln"> usdt </span><span class="kwd">in</span><span class="pln"> usdts</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">    usdt</span><span class="pun">.</span><span class="pln">enable_probe</span><span class="pun">(</span><span class="str">"query__start"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"probe_start"</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    usdt</span><span class="pun">.</span><span class="pln">enable_probe</span><span class="pun">(</span><span class="str">"query__done"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"probe_end"</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">bpf </span><span class="pun">=</span><span class="pln"> BPF</span><span class="pun">(</span><span class="pln">text</span><span class="pun">=</span><span class="pln">program</span><span class="pun">,</span><span class="pln"> usdt_contexts</span><span class="pun">=</span><span class="pln">usdts</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pun">...</span></code></li><li class="L8"><code><span class="com">// 获取结果集</span></code></li><li class="L9"><code><span class="pln">latencies </span><span class="pun">=</span><span class="pln"> bpf</span><span class="pun">[</span><span class="str">"latency"</span><span class="pun">]</span></code></li><li class="L0"><code><span class="pun">...</span></code></li><li class="L1"><code><span class="com">// 打印结果集</span></code></li><li class="L2"><code><span class="pln">latencies</span><span class="pun">.</span><span class="pln">print_log2_hist</span><span class="pun">(</span><span class="str">"query latency (%s)"</span><span class="pln"> </span><span class="pun">%</span></code></li><li class="L3"><code><span class="pln">                          </span><span class="pun">(</span><span class="str">"us"</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> args</span><span class="pun">.</span><span class="pln">microseconds </span><span class="kwd">else</span><span class="pln"> </span><span class="str">"ms"</span><span class="pun">))</span></code></li><li class="L4"><code><span class="pun">...</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h3 data-anchor-id="lyrr" id="bpf-限制">BPF 限制</h3><ul data-anchor-id="r28h">
<li>OS内核版本, &gt;= 4.4 存在统计Bug, 部分功能需要&gt;= 4.13</li>
<li>"bcc.usdt.USDTException: failed to enable probe 'query__start'; a possible cause can be that the probe requires a pid to enable” 需要有Dtrace tracepoint的MySQL, 需要重新编译. <a href="https://dev.mysql.com/doc/refman/5.7/en/dba-dtrace-server.html" target="_blank">https://dev.mysql.com/doc/refman/5.7/en/dba-dtrace-server.html</a></li>
<li>使用bcc需要root权限</li>
</ul><hr><div class="md-section-divider"></div><h2 data-anchor-id="47aw" id="pmc应用一例">PMC应用一例</h2><div class="md-section-divider"></div><h3 data-anchor-id="i7v0" id="pmc-介绍">PMC 介绍</h3><p data-anchor-id="ypuj">PMC = Performance Monitoring Counter</p><p data-anchor-id="2pyw"><a href="https://en.wikipedia.org/wiki/Hardware_performance_counter" target="_blank">https://en.wikipedia.org/wiki/Hardware_performance_counter</a></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ikys"><ol class="linenums"><li class="L0"><code><span class="typ">In</span><span class="pln"> computers</span><span class="pun">,</span><span class="pln"> hardware performance counters</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> hardware counters are a </span><span class="kwd">set</span><span class="pln"> of special</span><span class="pun">-</span><span class="pln">purpose registers built </span><span class="kwd">into</span><span class="pln"> modern microprocessors to store the counts of hardware</span><span class="pun">-</span><span class="pln">related activities within computer systems</span><span class="pun">.</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="zpaq" id="innodbnumainterleave-的作用">innodb_numa_interleave 的作用</h3><p data-anchor-id="9po3"><a href="https://image.slidesharecdn.com/yasuigraph500uv2000hpccon2015-151013061021-lva1-app6892/95/numaaware-threadparallel-breadthfirst-search-for-graph500-and-green-graph500-benchmarks-on-sgi-uv-2000-9-638.jpg?cb=1444716769" target="_blank">NUMA</a></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="zmpq"><ol class="linenums"><li class="L0"><code><span class="com">// innodb_numa_interleave=off</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/data/</span><span class="pln">mysql3306</span><span class="com"># perf stat -e 'offcore_response.demand_data_rd.llc_miss.remote_dram' -p 21932 sleep 10</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="typ">Performance</span><span class="pln"> counter stats </span><span class="kwd">for</span><span class="pln"> process id </span><span class="str">'21932'</span><span class="pun">:</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">         </span><span class="lit">7</span><span class="pun">,</span><span class="lit">827</span><span class="pun">,</span><span class="lit">310</span><span class="pln">      offcore_response</span><span class="pun">.</span><span class="pln">demand_data_rd</span><span class="pun">.</span><span class="pln">llc_miss</span><span class="pun">.</span><span class="pln">remote_dram                                   </span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">      </span><span class="lit">10.003751145</span><span class="pln"> seconds time elapsed</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="twug"><ol class="linenums"><li class="L0"><code><span class="com">//innodb_numa_interleave=on</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">root@R820</span><span class="pun">-</span><span class="lit">08</span><span class="pun">:</span><span class="str">/data/</span><span class="pln">mysql3306</span><span class="com"># perf stat -e 'offcore_response.demand_data_rd.llc_miss.remote_dram' -p 20718 sleep 10</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="typ">Performance</span><span class="pln"> counter stats </span><span class="kwd">for</span><span class="pln"> process id </span><span class="str">'20718'</span><span class="pun">:</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="lit">25</span><span class="pun">,</span><span class="lit">638</span><span class="pun">,</span><span class="lit">580</span><span class="pln">      offcore_response</span><span class="pun">.</span><span class="pln">demand_data_rd</span><span class="pun">.</span><span class="pln">llc_miss</span><span class="pun">.</span><span class="pln">remote_dram                                   </span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">      </span><span class="lit">10.003196505</span><span class="pln"> seconds time elapsed</span></code></li></ol></pre></div>
</body>
</html>